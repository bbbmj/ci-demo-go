integration:
  services: # run some micro services container which depend by the integration test
    mongo:
      image: index.caicloud.io/caicloud/mongo:3.0.5
      command: mongod --smallfiles
  image: index.caicloud.io/caicloud/golang:1.6 # run a golang container to compile executable files and do integration test
  environment:
    - BUILD_DIR=/go/src/github.com/caicloud/ci-demo-go
  commands: 
    - mkdir -p $BUILD_DIR
    - cp ./ -rf $BUILD_DIR
    - cd $BUILD_DIR/code
    - go build -v -o app # compile executable files 
    - $BUILD_DIR/code/app & # run executable files 
    - echo "do some test" # do integration test

pre_build:
  image: index.caicloud.io/caicloud/golang:1.6 # run a container to compile publish executable files
  volumes:
    - .:/go/src/github.com/caicloud/ci-demo-go # mount source file to GOPATH
  commands: # compile
    - echo "compile executable files"
    - cd /go/src/github.com/caicloud/ci-demo-go/code
    - go build -v -o app
  outputs: # copy out publish executable files from prebuild container
    - /go/src/github.com/caicloud/ci-demo-go/code/app

build: #build pubilsh image
  dockerfile_name: Dockerfile_publish
